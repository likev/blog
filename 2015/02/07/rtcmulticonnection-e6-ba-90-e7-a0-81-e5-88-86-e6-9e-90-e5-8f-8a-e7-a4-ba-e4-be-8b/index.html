<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> RTCMultiConnection源码分析及示例 · HanDong's Blog</title><meta name="description" content="RTCMultiConnection源码分析及示例 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/html5-audio-player/" target="_self" class="nav-list-link">MUSIC</a></li><li class="nav-list-item"><a href="https://twitter.com/likev" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/likev" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">RTCMultiConnection源码分析及示例</h1><div class="post-time">Feb 7, 2015</div><div class="post-content"><p>RTCMultiConnection是运行在RTCPeerConnection API之上的WebRTC JavaScript包装库，可以实现基于WebRTC的点对点多人会话，点对点文件分享，以及视频聊天等功能。<br>下面对RTCMultiConnection的部分源代码(基于 <a href="https://github.com/muaz-khan/RTCMultiConnection/blob/df1d23d155dfb0e9f4983581043d22d4794c45ae/RTCMultiConnection.js" title="v2.2.5源码查看" target="_blank" rel="external">v2.2.5</a>)进行简单分析。</p>
<pre lang="javascript" line="1679">
 var iceServers = [];
iceServers.push({
url: 'stun:stun.l.google.com:19302'
});
iceServers.push({
url: 'stun:stun.anyfirewall.com:3478'
});
iceServers.push({
url: 'turn:turn.bistri.com:80',
credential: 'homeo',
username: 'homeo'
});
iceServers.push({
url: 'turn:turn.anyfirewall.com:443?transport=tcp',
credential: 'webrtc',
username: 'webrtc'
});
connection.iceServers = iceServers;
</pre>
上述源代码配置了STUN和TURN服务器，使用时可以用新的配置覆盖。这个地址列出了可用的 [STUN server list](https://gist.github.com/zziuni/3741933 "STUN server list")

<pre lang="javascript" line="1278">
 // resources used in RTCMultiConnection
connection.resources = {
RecordRTC: 'https://cdn.webrtc-experiment.com/RecordRTC.js',
PreRecordedMediaStreamer: 'https://cdn.webrtc-experiment.com/PreRecordedMediaStreamer.js',
customGetUserMediaBar: 'https://cdn.webrtc-experiment.com/navigator.customGetUserMediaBar.js',
html2canvas: 'https://cdn.webrtc-experiment.com/screenshot.js',
hark: 'https://cdn.webrtc-experiment.com/hark.js',
firebase: 'https://cdn.webrtc-experiment.com/firebase.js',
firebaseio: 'https://chat.firebaseIO.com/',
muted: 'https://cdn.webrtc-experiment.com/images/muted.png',
getConnectionStats: 'https://cdn.webrtc-experiment.com/getConnectionStats.js',
FileBufferReader: 'https://cdn.webrtc-experiment.com/FileBufferReader.js'
};
// www.RTCMultiConnection.org/docs/body/
connection.body = document.body || document.documentElement;
// www.RTCMultiConnection.org/docs/peers/
connection.peers = {};
// www.RTCMultiConnection.org/docs/firebase/
connection.firebase = 'chat';
</pre>

<pre lang="javascript" line="2451">
 // www.RTCMultiConnection.org/docs/openSignalingChannel/
// http://goo.gl/uvoIcZ
connection.openSignalingChannel = function(config) {
// make sure firebase.js is loaded
if (!window.Firebase) {
return loadScript(connection.resources.firebase, function() {
connection.openSignalingChannel(config);
});
}
var channel = config.channel || connection.channel;
if (connection.firebase) {
// for custom firebase instances
connection.resources.firebaseio = connection.resources.firebaseio.replace('//chat.', '//' + connection.firebase + '.');
}
var firebase = new window.Firebase(connection.resources.firebaseio + channel);
firebase.channel = channel;
firebase.on('child_added', function(data) {
config.onmessage(data.val());
});
firebase.send = function(data) {
// a quick dirty workaround to make sure firebase
// shouldn't fail for NULL values.
for (var prop in data) {
if (isNull(data[prop]) || typeof data[prop] === 'function') {
data[prop] = false;
}
}
this.push(data);
};
if (!connection.socket) {
connection.socket = firebase;
}
firebase.onDisconnect().remove();
setTimeout(function() {
config.callback(firebase);
}, 1);
};
connection.Plugin = Plugin;
};
</pre>

<p>RTCMultiConnection默认使用了 <a href="https://chat.firebaseIO.com/" target="_blank" rel="external">https://chat.firebaseIO.com/</a> 信号服务，使用时可修改为自己的firebase地址 <code>connection.firebase = &#39;yourname&#39;;</code><br>也可使用其他服务端信号实现，在客户端重载openSignalingChannel函数，详见 <a href="https://github.com/muaz-khan/WebRTC-Experiment/blob/master/Signaling.md" title="信号实现方式" target="_blank" rel="external">https://github.com/muaz-khan/WebRTC-Experiment/blob/master/Signaling.md</a>的介绍。</p>
<p>完整示例：</p>
<pre lang="javascript">
<!DOCTYPE html>
<!--

-->

<html>

<head>
  <meta charset="utf-8">
  <title>利用RTCMultiConnection进行基于WebRTC的实时多人点对点文字聊天和文件分享</title>
  <script src="http://www.webrtc-experiment.com/firebase.js"></script>
  <script src="http://www.webrtc-experiment.com/RTCMultiConnection.js"></script>
  <script src="http://www.webrtc-experiment.com/FileBufferReader.js"></script>
</head>

<body>
  <section>

## Open Data Channel

    <input type="text" id="channel" value="channel" style="font-size: 1.1em; text-align: right; width: 4em;" title="channel name - use your own channel name">
    <button id="init-RTCMultiConnection">Open</button>
    <span>or join:</span>
    <button id="join-RTCMultiConnection">Join</button>
  </section>

  <div id="chat-output"></div>
  <input type="text" id="chat-input" style="font-size: 1.2em;" placeholder="chat message" disabled>

## Share Files

  <input type="file" id="file" disabled>

  <div id="file-progress"></div>

  <script>
        var d = document;
        d.$ = document.getElementById;
        d.$('channel').value = Math.round(Math.random() * 60535) + 500000;
        var connection = new RTCMultiConnection();

        connection.session = {
            data: true
        };

        var iceServers = [];
        iceServers.push({
            url: 'stun:stun.services.mozilla.com'
        });

        /* Google服务不通
        iceServers.push({
            url: 'stun:stun.l.google.com:19302'
        });

        iceServers.push({
            url: 'stun:stun.anyfirewall.com:3478'
        });
*/
        iceServers.push({
            url: 'turn:turn.bistri.com:80',
            credential: 'homeo',
            username: 'homeo'
        });

        iceServers.push({
            url: 'turn:turn.anyfirewall.com:443?transport=tcp',
            credential: 'webrtc',
            username: 'webrtc'
        });

        connection.iceServers = iceServers;

        // [optional] onmessage/onopen is for sending/receiving data/text
        connection.onmessage = function(e) {
            appendDIV(e.data);
        };

        connection.onopen = function() {
            if (d.$('chat-input')) d.$('chat-input').disabled = false;
            if (d.$('file')) d.$('file').disabled = false;

            if (d.$('init-RTCMultiConnection')) d.$('init-RTCMultiConnection').disabled = true;
        };

        connection.onerror = function (e) {
            // e.userid
            // e.extra
             console.log(e);
        }

        d.$('init-RTCMultiConnection').onclick = function() {
            connection.open(d.$('channel').value || 'channel');
            d.$('join-RTCMultiConnection').disabled = true;
            d.$('init-RTCMultiConnection').disabled = true;
        };

        d.$('join-RTCMultiConnection').onclick = function() {
            connection.connect(d.$('channel').value || 'channel');
            d.$('join-RTCMultiConnection').disabled = true;
            d.$('init-RTCMultiConnection').disabled = true;
        };

        d.$('file').onchange = function() {
            var file = this.files[0];
            connection.send(file);
        };

        var chatOutput = d.$('chat-output');

        connection.body = d.$('file-progress');

        function appendDIV(data) {
            var div = document.createElement('div');
            div.innerHTML = data;

            chatOutput.insertBefore(div, chatOutput.firstChild);

            div.tabIndex = 0;
            div.focus();
        }

        d.$('chat-input').onkeypress = function(e) {
            if (e.keyCode !== 13 || !this.value) return;
            appendDIV(this.value);
            connection.send(this.value);
            this.value = '';
            this.focus();
        };
  </script>
</body>

</html>
</pre>

<p><a href="http://www.rtcmulticonnection.org/docs/constructor/" title="构造函数" target="_blank" rel="external">new RTCMultiConnection</a>(‘channel-id’);创建一个信道，参数为空时默认信道名为完整URL。<br><a href="http://www.rtcmulticonnection.org/docs/open/" title="创建会话" target="_blank" rel="external">connection.open</a>(‘session-id’); 在当前信道创建一个会话，可理解为一个房间。一个信道可以有多个房间。<br><a href="http://www.rtcmulticonnection.org/docs/connect/" title="连接会话" target="_blank" rel="external">connection.connect</a>(‘session-id’);连接新的socket或使用已有socket，等待onNewSession事件，然后默认connection.join(session);</p>
<p>RTCMultiConnection官方网站及文档和示例：<a href="http://www.rtcmulticonnection.org/" title="打开网址" target="_blank" rel="external">http://www.rtcmulticonnection.org/</a><br>firebaseAPI：<a href="https://www.firebase.com/docs/web/api/" title="打开网址" target="_blank" rel="external">https://www.firebase.com/docs/web/api/</a></p>
<hr>
<p>其他基于WebRTC的JavaScript类库</p>
<ol>
<li><a href="http://peerjs.com/" title="打开官网" target="_blank" rel="external">PeerJS</a>简化WebRTC点对点数据、音视频通话。同样需要PeerServer来协商会话双方，可使用官网提供的免费服务。</li>
<li><a href="https://rtc.io/" title="打开官网" target="_blank" rel="external">rtc.io</a>是一个node.js的模块集合，可用来简化WebRTC开发</li>
<li><a href="https://simplewebrtc.com/" title="打开官网" target="_blank" rel="external">https://simplewebrtc.com/</a>由一些独立的模块构成</li>
<li><a href="http://sipjs.com/" title="打开官网" target="_blank" rel="external">http://sipjs.com/</a>和peerjs类似，同样需要SIP服务，可使用他们的付费<a href="https://signup.onsip.com/sipjs" title="注册OnSIP服务" target="_blank" rel="external">OnSIP服务</a></li>
</ol>
</div></article></div></section><footer><div class="paginator"><a href="/2015/11/04/Junkware-and-Malware-Removal-Tool/" class="prev">PRVE</a><a href="/2014/11/22/e6-94-af-e6-8c-81-e9-80-9a-e9-85-8d-e7-ac-a6-e5-92-8c-e6-ad-a3-e5-88-99-e8-a1-a8-e8-be-be-e5-bc-8f-e7-9a-84hosts-e6-96-87-e4-bb-b6-e6-9c-ac-e5-9c-b0dns-e7-bc-93-e5-ad-98-e5-8f-8a-e4-bb-a3-e7-90-86/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://blog.tianqi.at">John Doe</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>