<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CPP程序监视plot文件夹并以post方式上传数据 · HanDong's Blog</title><meta name="description" content="CPP程序监视plot文件夹并以post方式上传数据 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CPP程序监视plot文件夹并以post方式上传数据</h1><div class="post-time">Nov 9, 2011</div><div class="post-content"><pre lang="cpp">
//#include <afxwin.h>         // MFC 核心和标准组件

#include <iostream>
#include <afxinet.h>
#include <string>
#include <fstream>
#include <sstream>

void display_post_result(std::string result)
{
    std::cout<<result<<std::endl; 20100115="" std::ofstream="" fout("log-info.txt",std::ios_base::out|std::ios_base::app);="" if(!fout.is_open())="" {="" std::cout<<"打开或创建文件log-info.txt失败!";="" return;="" }="" ctime="" now="CTime::GetCurrentTime();" fout<<now.format("[%y-%m-%d="" %h:%m:%s]:="" \r\n")<<result<<std::endl;="" bool="" posthttppage(const="" std::string&="" hostname,="" const="" pathname,="" postdata)="" using="" namespace="" std;="" cinternetsession="" session("mozilla="" 5.0="" (windows;="" u;="" windows="" nt="" 5.1;="" zh-cn;="" rv:1.9.2)="" gecko="" firefox="" 3.6");="" try="" internet_port="" nport="80;" dword="" dwret="0;" chttpconnection*="" pserver="session.GetHttpConnection(hostName.c_str()," nport);="" chttpfile*="" pfile="pServer-">OpenRequest(CHttpConnection::HTTP_VERB_POST, pathName.c_str());

        CString strHeaders = "Content-Type: application/x-www-form-urlencoded"; // 请求头

        display_post_result("posting data...");

        pFile->SendRequest(strHeaders,(LPVOID)postData.c_str(),postData.size());
        pFile->QueryInfoStatusCode(dwRet);

        if (dwRet == HTTP_STATUS_OK)
        {
            CString result, newline;

            while(pFile->ReadString(newline))
            {
                result += newline+"\r\n";
            }

            display_post_result(("back:"+result).GetBuffer());
        }
        else
        {
            display_post_result("post 失败！");
            return false;
        }
        delete pFile;
        delete pServer;

    }
    catch (CInternetException* pEx)
    {
        //catch errors from WinInet
        TCHAR pszError[200];
        pEx->GetErrorMessage(pszError, 200);

        display_post_result(pszError);
        return false;
    }
    session.Close();

    return true;
}

bool deal_plot_file(std::string orgine_name, std::string &result)
{
    std::ifstream fin(orgine_name.c_str());
    if(!fin.is_open())
    {
        display_post_result("打开文件"+orgine_name+"失败！");
        return false;
    }

    display_post_result("dealing "+orgine_name+"...");

    result = "";
    std::string linestr, number;

    std::istringstream stringin;
    while(std::getline(fin,linestr))
    {
        stringin.clear();
        stringin.str(linestr);
        if(stringin>>number)
        {
            if(number.size() == 5)
            {
                result += number;
                //读取并丢弃经纬度高度和站点级别信息
                stringin>>number>>number>>number>>number;

                while(stringin>>number)
                {
                    result += ' ' + number;
                }
                //result += "\r\n";

            }
            else
            {
                result += linestr + "\r\n";
            }
        }
    }

    return true;
}

CTime get_last_time()
{
    int year,month,day,hour,minute,second;

    year   = GetPrivateProfileInt("lastest","year",1970,"./scan.ini");
    month  = GetPrivateProfileInt("lastest","month",1,"./scan.ini");
    day    = GetPrivateProfileInt("lastest","day",2,"./scan.ini");
    hour   = GetPrivateProfileInt("lastest","hour",0,"./scan.ini");
    minute = GetPrivateProfileInt("lastest","minute",0,"./scan.ini");
    second = GetPrivateProfileInt("lastest","second",0,"./scan.ini");

    return CTime(year,month,day,hour,minute,second);
}

bool set_latest_time(const CTime &latest)
{
    BOOL year,month,day,hour,minute,second;

    year   = WritePrivateProfileString("lastest","year",latest.Format("%Y"),"./scan.ini");
    month  = WritePrivateProfileString("lastest","month",latest.Format("%#m"),"./scan.ini");
    day    = WritePrivateProfileString("lastest","day",latest.Format("%#d"),"./scan.ini");
    hour   = WritePrivateProfileString("lastest","hour",latest.Format("%#H"),"./scan.ini");
    minute = WritePrivateProfileString("lastest","minute",latest.Format("%#M"),"./scan.ini");
    second = WritePrivateProfileString("lastest","second",latest.Format("%#S"),"./scan.ini");

    return year && month && day && hour && minute && second;
}

std::string get_plot_dir()
{
    char dir_buf[1024] ;
    DWORD result = GetPrivateProfileString("path","plotdir","Z:/surface/plot/",dir_buf,1000,"./scan.ini");

    return dir_buf;
}

bool scan_plot_dir()
{
    CTime last_time = get_last_time();

    CFileFind finder;

    std::string dir = get_plot_dir();
    if('\\' != dir[dir.size()-1 ] && '/' != dir[dir.size()-1 ] )
    {
        dir += '/';
    }
    BOOL bWorking = finder.FindFile( (dir+ "*.000").c_str() );

    CTime lastest(1), ftime;
    std::string result;
    //

    while (bWorking)
    {
        bWorking = finder.FindNextFile();

        if(finder.GetLastWriteTime(ftime) 
            && ftime > last_time 
            && deal_plot_file(finder.GetFilePath().GetBuffer(), result) 
            )
        {
            bool is_post_success = 
                PostHttpPage("current.sinaapp.com","update-mysql-from-post.php","app-content="+result);

            if(!is_post_success) 
            {//有一次post不成功就返回本次dir scan
                display_post_result("post maybe failure...");
                return false;
            }

            lastest = ftime > lastest ? ftime : lastest;

            display_post_result("wait 2 minute...");
            Sleep(2*1000*60);//post成功时等待2分钟
            display_post_result("continue next file find...");
        }
    }

    if(CTime(1) != lastest ) 
    {
        return set_latest_time(lastest);
    }

    return false;
}

int main(void)
{
    std::cout<<"version 5="" 1.1="" 2011-11-09\n"="" <<"-------------------------------------\n";="" while(true)="" {="" scan_plot_dir();="" display_post_result("wait="" minute...");="" sleep(5*1000*60);="" 每次dir="" scan完成时等待5分钟="" display_post_result("continue="" next="" plot="" dir="" scan...");="" }="" <="" pre=""></"version></result<<std::endl;></sstream></fstream></string></afxinet.h></iostream></afxwin.h></pre></div></article></div></section><footer><div class="paginator"><a href="/2011/11/10/c-e7-a8-8b-e5-ba-8f-e8-af-bb-e5-8f-96-e5-92-8c-e4-bf-9d-e5-ad-98-e9-85-8d-e7-bd-ae-e4-bf-a1-e6-81-af/" class="prev">上一篇</a><a href="/2011/11/09/c-e8-8e-b7-e5-8f-96-e6-96-87-e4-bb-b6-e4-bf-a1-e6-81-af/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://blog.tianqi.at">John Doe</a>, unless otherwise noted.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>