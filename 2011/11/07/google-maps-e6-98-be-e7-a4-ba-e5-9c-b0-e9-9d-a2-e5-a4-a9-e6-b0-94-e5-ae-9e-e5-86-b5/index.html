<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Google Maps 显示地面天气实况 · HanDong's Blog</title><meta name="description" content="Google Maps 显示地面天气实况 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/html5-audio-player/" target="_self" class="nav-list-link">MUSIC</a></li><li class="nav-list-item"><a href="https://twitter.com/likev" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/likev" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Google Maps 显示地面天气实况</h1><div class="post-time">Nov 7, 2011</div><div class="post-content"><p>一、用到的技术<br>1.Google Maps API<br>2.jQuery &amp; jQuery UI &amp;jqPlot<br>3.canvas 绘制风速及UI<br>4.mysql 站点信息表 &amp; 站点-时间-观测数据 表 &amp;其他信息表(站点和数据最近更新时间、最新数据时间)<br>5.php返回json形式站点信息并在客户端持久存储<br>6.Ajax轮询请求获取最新数据<br>7.GeoLocation获取用户地理位置并定位<br>8.鼠标悬停站点时显示基本信息，点击detail时Ajax获取本站点最详尽信息<br>9.Javascript解析数据代码为天气信息，计算湿度和本站气压等<br>10.统计某一段时间数据(单站数据或多站对比)<br>11.C++ 自动监测处理(去掉站点经纬度高度等信息)地面图文件并post数据 &amp; 网页手动上传文件更新(提供基本上传和拖动上传方式)</p>
<p>地面填图文件示例：<a href="http://grow-wordpress.stor.sinaapp.com/uploads/2011/11/11110620.000.txt" target="_blank" rel="external">11110620.000</a></p>
<p>二、代码实现<br>1.创建站点数据表</p>
<pre lang="mysql">
CREATE TABLE IF NOT EXISTS station(
id INT UNSIGNED NOT NULL UNIQUE PRIMARY KEY ,
lon DOUBLE NOT NULL ,
lat DOUBLE NOT NULL ,
height DOUBLE NOT NULL ,
LEVEL TINYINT UNSIGNED NOT NULL ,
name VARCHAR( 50 )
);
</pre>
2.创建地面观测数据表
<pre lang="mysql">
CREATE TABLE IF NOT EXISTS surface(
recordId int(10) unsigned NOT NULL AUTO_INCREMENT,
 stationId int(10) unsigned NOT NULL,
 recordTime datetime NOT NULL,
 totalCloudAmount smallint(5) unsigned NOT NULL,
 windDirection smallint(5) unsigned NOT NULL,
 windSpeed smallint(5) unsigned NOT NULL,
 seaLevelPressure smallint(5) unsigned NOT NULL,
 press3hour smallint(6) NOT NULL,
 pastWeather1 smallint(5) unsigned NOT NULL,
 pastWeather2 smallint(5) unsigned NOT NULL,
 hour6precipitation double NOT NULL,
 lowCloudAmount smallint(5) unsigned NOT NULL,
 lowCloudShape smallint(5) unsigned NOT NULL,
 lowCloudHight smallint(5) unsigned NOT NULL,
 dewpoint double NOT NULL,
 visibility double unsigned NOT NULL,
 presentWeather smallint(5) unsigned NOT NULL,
 temperature double NOT NULL,
 middleCloudShape smallint(5) unsigned NOT NULL,
 highCloudShape smallint(5) unsigned NOT NULL,
 transformT24 smallint(6) NOT NULL,
 transformPress24 smallint(6) NOT NULL,
 PRIMARY KEY (recordId),
 UNIQUE KEY stationId (stationId,recordTime)
) ENGINE=MyISAM DEFAULT CHARSET=utf8
</pre>

<p>每个月数据约100万行，可每个月建立一张表</p>
<pre lang="mysql">
CREATE TABLE IF NOT EXISTS `surface201111` LIKE surface;
</pre>

<p>3.插入数据到station表</p>
<pre lang="php">
function update_stations($content){
    preg_match_all('/^(\d{5})\s+(-?\d+\.\d+)\s+(-?\d+\.\d+)\s+(-?\d+)\s+(\d+)/m',$content,$matchs,PREG_SET_ORDER);

    //print_r($matchs);

    $sql = 'INSERT IGNORE INTO station (id, lon, lat, height, level) VALUES ';

    for($i = 0; $i < count($matchs); $i++){
        $sql .= '( ';

        for($j = 1; $j < 5; $j++){
            $sql .= $matchs[$i][$j].",";
        }
        $sql .= $matchs[$i][5] .' )';
        if($i < count($matchs) - 1)
        {
            $sql .= ',';
        }
    }
    //echo $sql;

    $mydb = new DB(SAE_MYSQL_HOST_M);
    return $mydb -> doSql($sql);
}
</pre>
4.插入数据到surface表
<pre lang="php">
function getSurfacePatten(){
    $patten = '/^(\d{5})(?:\s+-?\d+\.\d+){2}(?:\s+-?\d+\s+\d+)';

    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';
    $patten .= '\s+(-?\d+)';
    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';

    $patten .= '\s+(\d*\.\d+|\d+)';

    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';

    $patten .= '\s+(-?\d*\.\d+|\d+)';
    $patten .= '\s+(\d*\.\d+|\d+)';
    $patten .= '\s+(\d+)';
    $patten .= '\s+(-?\d*\.\d+|\d+)';

    $patten .= '\s+(\d+)';
    $patten .= '\s+(\d+)';

    $patten .= '\s+\d+';
    $patten .= '\s+\d+';

    $patten .= '\s+(-?\d+)';
    $patten .= '\s+(-?\d+)';

    $patten .= '/m';

    return $patten;
}

function update_surface($content){

    preg_match('/(\d+)\s+(0?\d+)\s+(0?\d+)\s+(0?\d+)\s+(\d+)\s*$/m',$content,$matchs);

    $year = $matchs[1] > '50' ? '19'.$matchs[1] : '20'.$matchs[1];
    $timestr = $year.$matchs[2].$matchs[3].$matchs[4].'0000';

    $patten = getSurfacePatten();

    preg_match_all($patten,$content,$matchs,PREG_SET_ORDER);

    //print_r($matchs);

    $sql = 'INSERT IGNORE INTO surface (';
    $sql .= 'recordTime,stationID,';
    $sql .= 'totalCloudAmount,windDirection,windSpeed,seaLevelPressure,press3hour,pastWeather1,pastWeather2,';
    $sql .= 'hour6precipitation,lowCloudAmount,lowCloudShape,lowCloudHight,';
    $sql .= 'dewpoint,visibility,presentWeather,temperature,';
    $sql .= 'middleCloudShape,highCloudShape,';
    $sql .= 'transformT24,transformPress24';
    $sql .= ' ) VALUES ';

    $mydb = new DB(SAE_MYSQL_HOST_M);

    for($i = 0; $i < count($matchs); $i++){
        $isexist = $mydb -> rows_of_select('select * from surface where stationId = '.$matchs[$i][1].' and recordTime = '.$timestr);

        if($isexist > 0) continue;

        $sql .= '( ';
        $sql .= $timestr.",";

        for($j = 1; $j < 20; $j++){
            $str = $matchs[$i][$j].",";
            $sql .= $str[0] === '.' ? '0'.$str : $str;
        }
        $sql .= $matchs[$i][20] .' )';
        if($i < count($matchs) - 1)
        {
            $sql .= ', ';
        }
    }

    return $mydb -> doSql($sql);
}
</pre>
5.更新站点信息(站点名称)
<pre lang="mysql">
update station set name = '顺义' where id=54398;
update station set name = '海淀' where id=54399;
update station set name = '延庆' where id=54406;
update station set name = '佛爷顶' where id=54410;
update station set name = '汤河口' where id=54412;
update station set name = '密云' where id=54416;
update station set name = '怀柔' where id=54419;
update station set name = '密云上甸子' where id=54421;
update station set name = '平谷' where id=54424;
update station set name = '通州' where id=54431;
update station set name = '朝阳' where id=54433;
update station set name = '昌平' where id=54499;
update station set name = '斋堂' where id=54501;
</pre>

<p>6.根据用户请求返回数据：</p>
<pre lang="mysql">
SELECT id, lon, lat,
LEVEL
FROM station
WHERE LEVEL <=2 30="" order="" by="" sqrt(="" lon="" *="" +="" lat="" )="" limit="" <="" pre="">

<p>7.检查是否有重复数据</p>
<pre lang="mysql">
SELECT recordTime, stationId, count( recordTime ) AS num
FROM `surface`
WHERE recordTime =20111111230000
GROUP BY stationId
LIMIT 500 
</pre>

<p>8.添加唯一性约束条件</p>
<pre lang="mysql">
delete FROM `surface`
WHERE stationId =99999;

alter table surface
add unique (stationId,recordTime);
</pre></=2></pre></div></article></div></section><footer><div class="paginator"><a href="/2011/11/08/jquery-1-7-e4-ba-8b-e4-bb-b6-e7-bb-91-e5-ae-9a-e5-87-bd-e6-95-b0/" class="prev">PRVE</a><a href="/2011/10/31/ncepdoe-reanalysis-ii/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://blog.tianqi.at">John Doe</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>