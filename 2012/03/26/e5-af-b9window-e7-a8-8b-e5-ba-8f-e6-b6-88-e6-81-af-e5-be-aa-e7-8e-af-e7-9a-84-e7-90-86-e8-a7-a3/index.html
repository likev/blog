<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 对Window程序消息循环的理解 · HanDong's Blog</title><meta name="description" content="对Window程序消息循环的理解 - John Doe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/html5-audio-player/" target="_self" class="nav-list-link">MUSIC</a></li><li class="nav-list-item"><a href="https://twitter.com/likev" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/likev" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">对Window程序消息循环的理解</h1><div class="post-time">Mar 26, 2012</div><div class="post-content"><ul>
<li><h3 id="1-每个-创建窗口的-线程有一个消息队列，程序用下面的循环接收、转换消息，并将消息分发到合适的窗口处理程序："><a href="#1-每个-创建窗口的-线程有一个消息队列，程序用下面的循环接收、转换消息，并将消息分发到合适的窗口处理程序：" class="headerlink" title="1.每个(创建窗口的)线程有一个消息队列，程序用下面的循环接收、转换消息，并将消息分发到合适的窗口处理程序："></a>1.每个(创建窗口的)线程有一个消息队列，程序用下面的循环接收、转换消息，并将消息分发到合适的窗口处理程序：</h3></li>
</ul>
<p><pre lang="cpp"><br>    MSG msg = { };<br>    while (GetMessage(&amp;msg, NULL, 0, 0))<br>    {<br>        TranslateMessage(&amp;msg);<br>        DispatchMessage(&amp;msg);<br>    }<br></pre></p>
<ul>
<li><h3 id="2-windows系统负责把消息放入每个线程的消息队列或者直接调用合适的窗口处理程序"><a href="#2-windows系统负责把消息放入每个线程的消息队列或者直接调用合适的窗口处理程序" class="headerlink" title="2.windows系统负责把消息放入每个线程的消息队列或者直接调用合适的窗口处理程序"></a>2.windows系统负责把消息放入每个线程的消息队列或者直接调用合适的窗口处理程序</h3></li>
<li><h3 id="3-Post消息和Send消息的区别"><a href="#3-Post消息和Send消息的区别" class="headerlink" title="3.Post消息和Send消息的区别"></a>3.<a href="http://msdn.microsoft.com/en-us/library/ff381405%28v=vs.85%29.aspx#posted_messages_versus_sent_messages" target="_blank" rel="external">Post消息和Send消息的区别</a></h3></li>
</ul>
<blockquote>
<p>a. Post一个消息(可以调用API函数<a href="http://msdn.microsoft.com/en-us/library/ms644944%28v=vs.85%29.aspx" target="_blank" rel="external">PostMessage</a>)表示消息将经过消息队列，通过消息循环来分发消息</p>
<p>b. Send一个消息(可以调用API函数<a href="http://msdn.microsoft.com/en-us/library/ms644950%28v=vs.85%29.aspx" target="_blank" rel="external">Send<span style="font-family: Consolas;">Message</span></a>)表示消息会跳过消息队列，操作系统直接调用窗口处理程序</p>
<ul>
<li><h3 id="4-可以在任意线程中发送自定义的消息-消息值-gt-WM-USER-到指定的窗口"><a href="#4-可以在任意线程中发送自定义的消息-消息值-gt-WM-USER-到指定的窗口" class="headerlink" title="4.可以在任意线程中发送自定义的消息(消息值&gt;= WM_USER)到指定的窗口"></a>4.可以在任意线程中发送自定义的消息(消息值&gt;= WM_USER)到指定的窗口</h3></li>
</ul>
</blockquote>
<ul>
<li><h3 id="5-消息队列"><a href="#5-消息队列" class="headerlink" title="5.消息队列"></a>5.<a href="http://msdn.microsoft.com/en-us/library/ms644927%28v=vs.85%29.aspx#quequed_messages" target="_blank" rel="external">消息队列</a></h3></li>
</ul>
<p>操作系统维护一个系统消息队列并为每一个GUI线程维护一个线程消息队列。为了避免为非GUI线程创建消息队列的开销，所有的线程在最初创建时没有消息队列。仅当线程第一次调用特定的用户函数时系统才创建一个线程消息队列；没有任何GUI函数的调用会导致消息队列的创建。</p>
<ul>
<li><h3 id="6-队列消息和非队列消息"><a href="#6-队列消息和非队列消息" class="headerlink" title="6.队列消息和非队列消息"></a>6.队列消息和非队列消息</h3></li>
</ul>
<p>a. 队列消息</p>
<blockquote>
<p>移动或点击鼠标、敲击键盘等大部分消息为队列消息。</p>
<p>仅当消息队列中没有其它消息时，<strong>WM_PAINT</strong>、<strong>WM_TIMER</strong>、<strong>WM_QUIT</strong>消息才被发送到窗口处理程序。</p>
<p>其它的消息按先进先出的原则被发送到窗口处理程序</p>
<p>用户可以用PostMessage等函数来发送一个队列消息<br>b. 非队列消息<br>比如当窗口转为active状态时，或者用户调用某些系统函数(如<strong><a href="http://msdn.microsoft.com/en-us/library/ms633545%28v=vs.85%29.aspx" target="_blank" rel="external">SetWindowPos</a></strong>)时，消息将跳过消息队列，直接发往窗口处理程序。</p>
<p>用户可以调用SendMessage等函数来发送一个非队列消息</p>
</blockquote>
</div></article></div></section><footer><div class="paginator"><a href="/2012/03/26/windows-e4-b8-ad-e7-9a-84-e5-a4-9a-e7-ba-bf-e7-a8-8b-e5-a4-84-e7-90-86/" class="prev">PRVE</a><a href="/2012/03/25/cpp-string-1/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://blog.tianqi.at">John Doe</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>