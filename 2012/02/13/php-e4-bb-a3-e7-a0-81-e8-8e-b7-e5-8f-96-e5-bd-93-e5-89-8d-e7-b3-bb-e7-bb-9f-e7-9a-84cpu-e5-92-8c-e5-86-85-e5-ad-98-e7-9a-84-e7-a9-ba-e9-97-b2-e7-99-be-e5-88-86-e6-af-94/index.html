<!DOCTYPE html><html lang="zh-cn,en,default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> PHP代码获取当前系统的CPU和内存的空闲百分比 · HanDong's Blog</title><meta name="description" content="PHP代码获取当前系统的CPU和内存的空闲百分比 - HanDong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/html5-audio-player/" target="_self" class="nav-list-link">MUSIC</a></li><li class="nav-list-item"><a href="https://twitter.com/likev" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/likev" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">PHP代码获取当前系统的CPU和内存的空闲百分比</h1><div class="post-time">2012年2月13日</div><div class="post-content"><p>设想我们有一个php页面A比较耗资源，因此在每次执行页面A中的代码前需要检测一下系统目前CPU和内存的空闲百分比。<br>我们可以利用下面几个函数来解决这个问题</p>
<pre lang="php">

//获取cpu的空闲百分比
function get_cpufree(){
    $cmd =  "top -n 1 -b -d 0.1 | grep 'Cpu'";//调用top命令和grep命令
    $lastline = exec($cmd,$output);

    preg_match('/(\S+)%id/',$lastline, $matches);//正则表达式获取cpu空闲百分比
    $cpufree = $matches[1];
    return $cpufree;
}
//获取内存空闲百分比
function get_memfree(){
    $cmd =  'free -m';//调用free命令
    $lastline = exec($cmd,$output);

    preg_match('/Mem:\s+(\d+)/',$output[1], $matches);
    $memtotal = $matches[1];
    preg_match('/(\d+)$/',$output[2], $matches);
    $memfree = $matches[1]*100.0/$memtotal;

    return $memfree;
}

//获取某个程序当前的进程数
function get_proc_count($name){
    $cmd =  "ps -e";//调用ps命令
    $output = shell_exec($cmd);

    $result = substr_count($output, ' '.$name);
    return $result;
}
</pre>

<p>比如当CPU空闲率小于30%时我们延迟页面A执行：</p>
<pre lang="php">
$cpufree = get_cpufree();

while( $cpufree<30 ){="" wait="" for="" 0.1="" seconds="" usleep(0.1*1000000);="" $cpufree="get_cpufree();" };="" <="" pre=""></30></pre></div></article></div></section><footer><div class="paginator"><a href="/2012/02/21/e7-a7-91-e5-ad-a6-e5-ae-b6-e9-83-a8-e7-bd-b2-e6-bf-80-e5-85-89-e5-99-a8-e3-80-81gps-e6-8a-80-e6-9c-af-e6-9d-a5-e6-94-b9-e5-96-84-e9-99-8d-e9-9b-aa-e6-b5-8b-e9-87-8f/" class="prev">上一篇</a><a href="/2012/02/09/e5-9c-a8-e7-ba-bf-e7-bb-98-e5-88-b6-e8-bf-9110-e5-b9-b4-e5-85-a8-e7-90-83-e5-a4-a9-e6-b0-94-e5-bd-a2-e5-8a-bf-e5-9b-be/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://blog.tianqitu.net">HanDong</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>