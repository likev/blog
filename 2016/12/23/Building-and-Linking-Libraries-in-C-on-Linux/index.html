<!DOCTYPE html><html lang="zh-cn,en,default"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Building and Linking Libraries in C on Linux · HanDong's Blog</title><meta name="description" content="Building and Linking Libraries in C on Linux - HanDong"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/html5-audio-player/" target="_self" class="nav-list-link">MUSIC</a></li><li class="nav-list-item"><a href="https://twitter.com/likev" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/likev" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Building and Linking Libraries in C on Linux</h1><div class="post-time">2016年12月23日</div><div class="post-content"><h2 id="C-Libraries"><a href="#C-Libraries" class="headerlink" title="C Libraries"></a>C Libraries</h2><p>In general, libraries are created from many library source files, and are either built as archive files (libmine.a) that are statically linked into executables that use them, or as shared object files (libmine.so) that are dynamically linked into executables that use them. To link in libraries of these types, use the gcc command line options -L for the path to the library files and -l to link in a library (a .so or a .a):<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-L&#123;path to file containing library&#125; -l$&#123;library name&#125;</span><br></pre></td></tr></table></figure></p>
<p>For example, if I have a library named libmine.so in /home/newhall/lib/ then I’d do the following to link it into my program:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o myprog myprog.c  -L/home/newhall/lib -lmine</span><br></pre></td></tr></table></figure></p>
<p>You may also need to specify and include path so the compiler can find the library header file: <code>-I /home/newhall/include</code></p>
<p>If you create your own shared object files and do not install them in <code>/usr/lib</code>, then you need to set your <code>LD_LIBRARY_PATH</code> environment variable so that the runtime linker can find them and load them at run time. For example, if I put my <code>.so</code> files in a directory named lib in my home directory, I’d set my <code>LD_LIBRARY_PATH</code> enviroment to the following:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if running bash:</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/home/newhall/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if running tcsh:</span></span><br><span class="line">setenv LD_LIBRARY_PATH /home/newhall/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="USING-AND-LINKING-LIBRARY-CODE"><a href="#USING-AND-LINKING-LIBRARY-CODE" class="headerlink" title="USING AND LINKING LIBRARY CODE"></a>USING AND LINKING LIBRARY CODE</h2><p>To use a Library that is not linked into your program automatically by<br>the compiler, you need to (1) include the library’s header file in your<br>C source file (test.c in the example below), and (2) tell the compiler to<br>link in the code from the library .o file into your executable file:</p>
<ul>
<li><p>step 1: Add an include line (#include “somelib.h”) in a program<br>source file (e.g., test.c).</p>
</li>
<li><p>step 2: Link the program’s .c file with the library object file<br>(i.e. specify the somelib.o file as a command line argument to gcc): </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% gcc  -o myprog test.c somelib.o</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>The resulting executable file (myprog) will contain machine code<br>for all the functions defined in test.c plus any mylib library<br>functions that are called by</p>
<h2 id="CREATING-AND-USING-YOUR-OWN-LIBRARY-CODE"><a href="#CREATING-AND-USING-YOUR-OWN-LIBRARY-CODE" class="headerlink" title="CREATING AND USING YOUR OWN LIBRARY CODE"></a>CREATING AND USING YOUR OWN LIBRARY CODE</h2><p>To create a Library of code you need to do the following:</p>
<ol>
<li>Create an INTERFACE to your library: mylib.h</li>
<li>Create an IMPLEMENTATION of your library: mylib.c</li>
<li>(a) Create a LIBRARY OBJECT FILE that can be linked with programs that want to use our library code<br>(b) or create a SHARED OBJECT FILE from many .o files that can be linked with programs that want to use your library code</li>
<li>USE the library in other C code:<br>(a) #include “mylib.h”<br>(b) link in the libary code into a.out file</li>
<li>Set LD_LIBRARY_PATH environment variable for finding shared objects in non-standard locations at runtime</li>
</ol>
<h4 id="Details"><a href="#Details" class="headerlink" title="Details:"></a>Details:</h4><p>(1) INTERFACE: the header file to your library should contain definitions for everything exported by your library:<br>function prototypes with comments for users of your library functions<br>definitions for types and global variables exported by your library </p>
<p>You should have “boiler plate” code (#ifndef … #endif) around the header file’s contents, to ensures that the preprocessor only includes the mylib.h file one time.</p>
<p>Here is what an example .h file might look like:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _MYLIB_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _MYLIB_H_</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a constant definition exported by library:</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_FOO  20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// a type definition exported by library:</span></span><br><span class="line"><span class="keyword">struct</span> foo_struct &#123;  </span><br><span class="line"><span class="keyword">int</span> x;</span><br><span class="line"><span class="keyword">float</span> y;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> foo_struct foo_struct;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a global variable exported by library</span></span><br><span class="line"><span class="comment">// "extern" means that this is not a variable declaration, it </span></span><br><span class="line"><span class="comment">// just defines that a variable named total_foo of type int</span></span><br><span class="line"><span class="comment">// exits and you can use it (its declaration is in some library source file)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> total_foo; 	</span><br><span class="line"></span><br><span class="line"><span class="comment">// a function prototype for a function exported by library:</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">float</span> y, <span class="keyword">float</span> z)</span></span>;   <span class="comment">// a very bad function name</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p>
<p>(2) IMPLEMENTATION: create a mylib.c file that #includes “mylib.h” and contains the implementation of every function in your library.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"mylib.h"</span></span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">int</span> total_foo;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">float</span> y, <span class="keyword">float</span> z)</span> </span>&#123; </span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>(3) create a LIBRARY OBJECT FILE that can be linked into other programs that use your library (use the -c option to gcc to tell it just to create an object file (a .o file) rather than an executable:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o mylib.o -c mylib.c</span><br></pre></td></tr></table></figure></p>
<p>you can then use the mylib.o file as the “library file” and statically link it into other programs that use it, or…</p>
<p>(3a) alternately, you can create a SHARED OBJECT FILE from one or more .o files that can be linked into other programs that use your library A shared object file is the Unix name for a dynamically linked library whose code is loaded into the a.out file at runtime. To create a .so file use the -shared flag to gcc. Here is what an example build might look like:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o libmylib.so  mylib.o blah.o grr.o  -lm</span><br></pre></td></tr></table></figure></p>
<p>(3b) you could also build an ARCHIVE FILE (a statically linked library, libmylib.a) from one or more .o files. If you link with a static library, its code is copied into the a.out file at runtime.</p>
<p>See gcc documentation for more information on how to build .a and .so files.</p>
<p>(4) USE the library in other programs:</p>
<p>step 1: Add an include line (#include “mylib.h”) in all program source files that use library definitions (e.g., test.c).</p>
<p>step 2: Link the program’s .c file with the library object file<br>(i.e. specify the mylib.o file as a command line argument to gcc):<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc  test.c mylib.o</span><br></pre></td></tr></table></figure></p>
<p>OR to link in libmylib.so (or libmylib.a):<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc  test.c -lmylib</span><br></pre></td></tr></table></figure></p>
<p>OR to link with a library not in the standard path:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc  test.c -L/home/newhall/lib -lmylib</span><br></pre></td></tr></table></figure></p>
<p>The resulting a.out out will contain machine code for all the functions<br>defined in test.c plus any mylib library functions that are called by<br>the test.c code. </p>
<p>(5) RUNNING an executable linked with a shared object file:</p>
<p>If the shared object file in not in /usr/lib, then you need to set your<br>LD_LIBRARY_PATH environment variable so that the runtime linker can find<br>and load your .so file into the executable at runtime:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># in bash:</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/home/newhall/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="comment"># in tcsh:</span></span><br><span class="line">setenv LD_LIBRARY_PATH /home/newhall/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a href="https://www.cs.swarthmore.edu/~newhall/unixhelp/howto_C_libraries.html" target="_blank" rel="external">https://www.cs.swarthmore.edu/~newhall/unixhelp/howto_C_libraries.html</a></p>
</blockquote>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/27/git-command-lists/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://blog.tianqitu.net">HanDong</a>, unless otherwise noted.</p></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>